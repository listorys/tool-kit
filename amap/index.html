<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="initial-scale=1.0, user-scalable=no, width=device-width"
    />
    <style>
      html,
      body,
      #container {
        width: 100%;
        height: 100%;
      }
      .control-box {
        position: fixed;
        z-index: 999;
        top: 10px;
        right: 10px;
        width: 300px;
        height: calc(100% - 20px);
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .input-data {
        flex-grow: 1;
      }
      .btn-box {
        display: flex;
        gap: 10px;
      }
      h3 {
        padding: 0;
        margin: 0;
      }
    </style>
    <title>åœ°å›¾å·¥å…·</title>
    <link
      rel="stylesheet"
      href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css"
    />
    <script src="https://a.amap.com/jsapi_demos/static/geojson/shanghai.js"></script>
    <script src="https://webapi.amap.com/maps?v=2.0&key=2dbbdb8f7fd9d482bf8189c12b530894"></script>
    <script src="https://a.amap.com/jsapi_demos/static/demo-center/js/demoutils.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://a.amap.com/jsapi_demos/static/resource/heatmapData.js"></script>
  </head>
  <body>
    <div class="vueBox" id="app">
      <div class="control-box">
        <h3>å›´æ </h3>
        <textarea
          class="input-data"
          v-model="polygonData"
          rows="30"
          placeholder="è¾“å…¥å›´æ æ•°æ®ï¼Œå¦‚POLYGON ((117.124023842 40.53388317100007, ...))"
        ></textarea>
        <h3>åæ ‡</h3>
        <textarea
          class="input-data"
          v-model="markerData"
          rows="30"
          placeholder="è¾“å…¥åæ ‡ç‚¹ï¼Œå¦‚POINT (115.975944 40.462026)...ï¼Œå¯å¤šä¸ª"
        ></textarea>
        <h3>çƒ­åŠ›</h3>
        <textarea
          class="input-data"
          v-model="heatMapData"
          rows="30"
          placeholder="è¾“å…¥çƒ­åŠ›æ•°æ®ï¼Œå¦‚"
        ></textarea>
        <div class="btn-box">
          <button @click="drawPolygon">ç”Ÿæˆå›´æ </button>
          <button @click="addMarker">ç”Ÿæˆåæ ‡</button>
          <button @click="drawHeatMap">ç”Ÿæˆçƒ­åŠ›</button>
          <button @click="clearPolygons">æ¸…ç©º</button>
        </div>
      </div>
    </div>
    <div id="container"></div>

    <script type="text/javascript">
      const { createApp, ref, mounted } = Vue;

      createApp({
        data() {
          return {
            map: null,
            polygonData: "",
            polygon: null,
            markerData: `POINT (115.975944 40.462026)
      POINT (116.8565085214192 40.38811656537166)
      POINT (116.8134796184506 40.36655759357838)`,
            points: [],
            heatMapData: "",
          };
        },
        mounted() {
          this.initMap();
          // this.polygonData = JSON.stringify(shanghai);
          // this.drawPolygon();
        },
        methods: {
          // åˆå§‹åŒ–åœ°å›¾
          initMap() {
            this.map = new AMap.Map("container", {
              resizeEnable: true,
              center: [121.045332, 31.19884],
              zoom: 8.8,
            });
          },
          // è½¬æ¢è¾“å…¥çš„å›´æ æ ¼å¼
          // parsePolygon(polygonStr) {
          //   // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–åæ ‡ç‚¹
          //   const pattern = /POLYGON \(\(([^)]+)\)\)/;
          //   const match = polygonStr.match(pattern);
          //   if (!match) {
          //     throw new Error("Invalid POLYGON format");
          //   }
          //   // æå–åæ ‡ç‚¹å­—ç¬¦ä¸²
          //   const coordsStr = match[1];
          //   // å°†åæ ‡ç‚¹å­—ç¬¦ä¸²åˆ†å‰²æˆå•ä¸ªåæ ‡ç‚¹
          //   const coordsList = coordsStr.split(",");
          //   // å°†æ¯ä¸ªåæ ‡ç‚¹å­—ç¬¦ä¸²è½¬æ¢ä¸ºæµ®ç‚¹æ•°åˆ—è¡¨
          //   const polygonList = coordsList.map((point) =>
          //     point.trim().split(" ").map(Number)
          //   );
          //   // å››å±‚åµŒå¥—åˆ—è¡¨
          //   const nestedPolygonList = [[polygonList]];
          //   return nestedPolygonList;
          // },
          // æ¸…ç©ºæ‰€æœ‰è¦†ç›–ç‰©
          clearPolygons() {
            console.log("map", this.map);
            this.map.clearMap();
          },
          // ç”»å›´æ 
          drawPolygon() {
            if (!this.polygonData) {
              alert("å•¥éƒ½ä¸è¾“å…¥ï¼Œè¿˜æƒ³ç”Ÿæˆæ˜¯å§ï¼Ÿç»™ä½ æ¥ä¸€ğŸ‘Š");
              return;
            }
            function extractCoordinates(polygonString) {
              // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…åæ ‡ç‚¹
              const coordinateRegex = /([\d\.]+ [\d\.]+)/g;
              const matches = polygonString.match(coordinateRegex);

              // å°†åŒ¹é…åˆ°çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°ç»„
              const coordinates = matches.map((match) => {
                const [longitude, latitude] = match.split(" ").map(Number);
                return [longitude, latitude];
              });

              return coordinates;
            }
            const path = extractCoordinates(this.polygonData);
            if (this.polygon) {
              this.polygon.setMap(null); // ç§»é™¤æ—§çš„å›´æ 
            }
            this.polygon = new AMap.Polygon({
              path,
              fillColor: "#ccebc5",
              strokeOpacity: 1,
              fillOpacity: 0.5,
              strokeColor: "#2b8cbe",
              strokeWeight: 1,
              strokeStyle: "dashed",
              strokeDasharray: [5, 5],
            });
            this.polygon.setMap(this.map);
            this.map.setFitView(); // è°ƒæ•´è§†è§’ä»¥å±•ç¤ºå®Œæ•´çš„å›´æ 
          },
          addMarker() {
            if (!this.markerData) {
              alert("å•¥éƒ½ä¸è¾“å…¥ï¼Œè¿˜æƒ³ç”Ÿæˆæ˜¯å§ï¼Ÿç»™ä½ æ¥ä¸€ğŸ‘Š");
              return;
            }
            const regex = /POINT \((-?\d+\.\d+)\s+(-?\d+\.\d+)\)/g; // æ­£åˆ™è¡¨è¾¾å¼ï¼ŒåŒ¹é…POINTè®°å½•

            this.points = [];
            let match;
            while ((match = regex.exec(this.markerData)) !== null) {
              this.points.push([parseFloat(match[1]), parseFloat(match[2])]); // æå–åŒ¹é…çš„æ•°å­—å¹¶è½¬æ¢ä¸ºNumberç±»å‹
            }

            if (!this.points?.length) {
              alert("æ ‡è®°æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„WKTæ ¼å¼");
              return;
            }
            this.points.forEach((item) => {
              const [lng, lat] = item;
              setMarker(new AMap.LngLat(lng, lat), this);
            });
            function setMarker(position, that) {
              var marker = new AMap.Marker({
                position,
                icon: "https://a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png",
                offset: new AMap.Pixel(-13, -30),
              });
              that.map.add(marker);
            }
            this.map.setFitView(); // è°ƒæ•´è§†è§’ä»¥å±•ç¤ºå®Œæ•´çš„å›´æ 
          },
          drawHeatMap() {
            console.log("heatmapData", heatmapData);
            var heatmap;
            const map = this.map;
            this.map.plugin(["AMap.HeatMap"], function () {
              console.log("map", map);
              //åˆå§‹åŒ–heatmapå¯¹è±¡
              heatmap = new AMap.HeatMap(map, {
                radius: 25, //ç»™å®šåŠå¾„
                opacity: [0, 0.8],
                /*,
                  gradient:{
                      0.5: 'blue',
                      0.65: 'rgb(117,211,248)',
                      0.7: 'rgb(0, 255, 0)',
                      0.9: '#ffea00',
                      1.0: 'red'
                  }
                   */
              });
              console.log("heatmap", heatmap);
              //è®¾ç½®æ•°æ®é›†ï¼šè¯¥æ•°æ®ä¸ºåŒ—äº¬éƒ¨åˆ†â€œå…¬å›­â€æ•°æ®
              heatmap.setDataSet({
                data: heatmapData,
                max: 100,
              });
            });
            // è®¡ç®—æ•°æ®ç‚¹çš„è¾¹ç•Œå¹¶è°ƒæ•´åœ°å›¾è§†é‡
            function setMapView(data) {
              var bounds = new AMap.Bounds(
                data[0].lng,
                data[0].lat,
                data[0].lng,
                data[0].lat
              );

              data.forEach(function (point) {
                bounds.extend(new AMap.LngLat(point.lng, point.lat));
              });

              map.setFitView(); // è‡ªåŠ¨è°ƒæ•´åˆ°åˆé€‚çš„è§†é‡èŒƒå›´
              map.setBounds(bounds);
            }
            setMapView(heatmapData);
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
